var JSONTreeLoader=function(a){this.subscribers=new Array();this.layout=a;this.dataGraph=a.dataGraph;this.lastCrumb=null};JSONTreeLoader.prototype.subscribe=function(a){this.subscribers.push(a)};JSONTreeLoader.prototype.notify=function(){for(var a=0;a<this.subscribers.length;a++){this.subscribers[a].notify()}};JSONTreeLoader.prototype.load=function(){var a=this;new Ajax.Request("/breadcrumbs/get_currcrumb_idx",{method:"get",onSuccess:function(b){window.CURR_CRUMB=parseInt(b.responseText)},onFailure:function(b){if(console.error){console.error("failed to get current breadcrumb index with response "+b)}}});new Ajax.Request("/breadcrumbs/get_breadcrumb",{asynchronous:false,method:"get",onFailure:function(b){if(console.error){console.error("failed to get breadcrumb for JSViz")}},onSuccess:function(b){a.handle(b)}})};JSONTreeLoader.prototype.handle=function(e){this.JSONDoc=e.responseJSON;if((this.JSONDoc.length==1)||(this.JSONDoc.length<this.dataGraph.nodes.length)){this.layout.clear();this.dataGraph.clear()}var c=this.JSONDoc[0];var f=c.params;var d=new DataGraphNode();d.root=true;d.text=this.nodeText(f);d.URL=this.reconstructURL(f);this.generateColorStrip();d.controller=f.controller;d.colorStripIndex=0;d.isAjax=c.is_ajax;d.fixed=true;d.distFromRoot=0;d.parent=new Array();d.children=$A(c.children);var b=this.dataGraph.findNode(d);d=(b)?this.dataGraph.getNode(b):d;if(window.CURR_CRUMB==0){d.color=this.colorStrip[d.colorStripIndex=0];d.current=true}else{d.color=(d.colorStripIndex<5)?this.colorStrip[d.colorStripIndex+=1]:this.colorStrip[5];d.current=false}if(b){this.layout.view.nodes[d.id].domElement.childNodes[0].setAttribute("fill",d.color)}else{this.dataGraph.addNode(d)}var a=this;c.children.each(function(g){this.lastNodeAdded=a.branch(g,d,0)});this.notify()};JSONTreeLoader.prototype.branch=function(m,g,j){var f=this.JSONDoc[m];var h=f.params;var a=new DataGraphNode();var b=this;a.text=this.nodeText(h);a.URL=this.reconstructURL(h);a.colorStripIndex=0;a.isAjax=f.is_ajax;a.distFromRoot=j;a.controller=h.controller;var o=this.dataGraph.findNode(a);a=(o)?this.dataGraph.getNode(o):a;if(!a.parent){a.parent=new Array()}a.parent.push(g);a.parent=a.parent.uniq();a.children=f.children;if(window.CURR_CRUMB==m){a.color=this.colorStrip[a.colorStripIndex=0];a.current=true}else{a.color=(a.colorStripIndex<5)?this.colorStrip[a.colorStripIndex+=1]:this.colorStrip[5];a.current=false}if(o){this.layout.view.nodes[a.id].domElement.childNodes[0].setAttribute("fill",a.color);var n=a.parent.last();var d=this.layout.view.edges[a.id][n.id]||this.layout.view.edges[n.id][a.id];if(!d){for(pdx in a.parent){p=a.parent[pdx];if(!p.id){continue}var k=this.layout.view.edges[a.id][p.id]||this.layout.view.edges[p.id][a.id];if(!k){if(pdx==(a.parent.size()-1)){break}continue}k.domEdge.setAttribute("stroke",this.colorStrip[1])}this.dataGraph.addEdge(a,g);var c=(a.type in this.layout.forces.spring&&g.type in this.layout.forces.spring[a.type])?this.layout.forces.spring[a.type][g.type](a,g,true):this.layout.forces.spring._default(a,g,true);this.layout.model.makeSpring(a.particle,g.particle,c.springConstant,c.dampingConstant,c.restLength);var l=this.layout.viewEdgeBuilder(g,a);this.layout.view.addEdge(a.particle,g.particle,l);this.layout.view.drawEdge(a.particle,g.particle)}else{d.domEdge.setAttribute("stroke",a.color)}}else{this.dataGraph.addNode(a)}f.children.each(function(e){b.branch(e,a,j+1)});return a};JSONTreeLoader.prototype.reconstructURL=function(d){var c=document.location;var b=d.action;var a=c.protocol+"//"+c.host+"/"+d.controller+"/";if(b!="index"&&b!="show"){a+=b+"/"}if(d.id){a+=d.id}return a};JSONTreeLoader.prototype.nodeText=function(d){var c="";var a=d.controller;var b=d.action;if(a=="root"){c="Home"}else{if(d.id){c=a[0].toUpperCase();if(d.action!="show"){c+=": "+b}c+=" "+d.id}else{if(a=="gallery"){c="Gallery: "+b[0].toUpperCase()+b.substring(1)}else{if(a=="myself"){c="Resume"}else{c=a[0].toUpperCase()+a.substring(1)}}}}return c};JSONTreeLoader.prototype.toggleText=function(){var c=$A(this.dataGraph.nodes);for(var a=0;a<c.size();a++){if(c[a].children.size()==0){this.layout.view.nodes[c[a].id].domElement.childNodes[1].style.visibility="visible";var b=c[a].distFromRoot}}this.layout.view.nodes[0].domElement.childNodes[1].style.visibility="visible"};JSONTreeLoader.prototype.generateColorStrip=function(){var f=Math.PI/10;var h=6;var a="#";var g=173;var c=204;var d=216;var b=204;var j=230;var e=204;this.colorStrip=new Array(6);for(i=0;i<h;i++){rComponent=Math.round(Math.sin(f*i)*(c-g)+g);gComponent=Math.round(Math.sin(f*i)*(b-d)+d);bComponent=Math.round(Math.sin(f*i)*(e-j)+j);this.colorStrip[i+1]=a+rComponent.toString(16)+gComponent.toString(16)+bComponent.toString(16)}this.colorStrip[0]="#D14A6C"};