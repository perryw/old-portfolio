var ForceDirectedLayout=function(a,e){this.container=a;this.containerLeft=0;this.containerTop=0;this.containerWidth=0;this.containerHeight=0;this.svg=e;if(this.svg){this.view=new SVGGraphView(a,1)}else{this.view=new HTMLGraphView(a,1)}this.model=new ParticleModel(this.view);this.model.start();this.setSize();this.dataNodeQueue=new Array();this.relationshipQueue=new Array();this.dataGraph=new DataGraph();this.dataGraph.subscribe(this);if(document.all){document.createStyleSheet().addRule("html",'filter:expression(document.execCommand("BackgroundImageCache", false, true))')}var d=new EventHandler(this,this.setSize);if(window.addEventListener){window.addEventListener("resize",d,false)}else{window.attachEvent("onresize",d)}var b=new EventHandler(this,this.handleMouseMoveEvent);if(document.addEventListener){document.addEventListener("mousemove",b,false)}else{document.attachEvent("onmousemove",b)}var c=new EventHandler(this,this.handleMouseUpEvent);if(document.addEventListener){document.addEventListener("mouseup",c,false)}else{document.attachEvent("onmouseup",c)}};ForceDirectedLayout.prototype.setSize=function(){if(this.container.tagName=="BODY"){if(document.all){this.containerWidth=document.body.offsetWidth-5;this.containerHeight=document.documentElement.offsetHeight-5}else{this.containerWidth=window.innerWidth-5;this.containerHeight=window.innerHeight-5}this.containerLeft=0;this.containerTop=0}else{this.containerWidth=this.container.offsetWidth;this.containerHeight=this.container.offsetHeight;this.containerLeft=this.container.offsetLeft;this.containerTop=this.container.offsetTop}this.view.setSize(this.containerLeft,this.containerTop,this.containerWidth,this.containerHeight);this.model.setSize(this.containerWidth,this.containerHeight);this.model.draw(true)};ForceDirectedLayout.prototype.handleMouseMoveEvent=function(f,c){if(this.model.selected&&!this.model.particles[this.model.selected].fixed){this.mouseMoved=true;document.body.style.cursor="move";if(this.mouseHover){document.getElementById("tooltip").style.display="none";this.mouseHover=false}c=arguments[arguments.length-1];var b=c.pageX?c.pageX:c.clientX;var a=c.pageY?c.pageY:c.clientY;var d=this.container.cumulativeOffset();b-=1*(this.view.centerX+d.left);a-=1*(this.view.centerY+d.top);this.model.particles[this.model.selected].positionX=b/this.view.skewX;this.model.particles[this.model.selected].positionY=a/this.view.skewY;this.model.tick()}};ForceDirectedLayout.prototype.handleMouseUpEvent=function(){if(this.model.selected){this.model.particles[this.model.selected].selected=false;this.model.reset();this.model.selected=null;if(this.mouseMoved){document.body.style.cursor=(this.mouseHover?"pointer":"default")}}};ForceDirectedLayout.prototype.handleMouseDownEvent=function(a){this.model.selected=a;this.model.particles[a].selected=true};ForceDirectedLayout.prototype.handleMouseClickEvent=function(b){var a=this.model.particles[b]};ForceDirectedLayout.prototype.newDataGraphNode=function(a){this.enqueueNode(a)};ForceDirectedLayout.prototype.newDataGraphEdge=function(b,a){this.enqueueRelationship(b,a)};ForceDirectedLayout.prototype.enqueueNode=function(a){this.dataNodeQueue.push(a)};ForceDirectedLayout.prototype.dequeueNode=function(){var a=this.dataNodeQueue.shift();if(a){this.addParticle(a);return true}return false};ForceDirectedLayout.prototype.enqueueRelationship=function(b,a){this.relationshipQueue.push({nodeA:b,nodeB:a})};ForceDirectedLayout.prototype.dequeueRelationship=function(){if(this.relationshipQueue.length==0){return false}var a=this.relationshipQueue[0];if(a&&a.nodeA.particle&&a.nodeB.particle){this.relationshipQueue.shift();this.addSimilarity(a.nodeA,a.nodeB);return true}else{this.relationshipQueue.push(a)}};ForceDirectedLayout.prototype.update=function(){this.dequeueNode();this.dequeueRelationship()};ForceDirectedLayout.prototype.clear=function(a){this.model.clear()};ForceDirectedLayout.prototype.recenter=function(a){};ForceDirectedLayout.prototype.config=function(a){this._default={model:function(b){return{mass:1}},view:function(b,c){return a.defaultNodeView(b,c)}}};ForceDirectedLayout.prototype.forces={spring:{_default:function(c,b,a){if(a){return{springConstant:0.5,dampingConstant:0.2,restLength:20}}else{return{springConstant:0.2,dampingConstant:0.2,restLength:20}}}},magnet:function(){return{magnetConstant:-2000,minimumDistance:10}}};ForceDirectedLayout.prototype.addParticle=function(g){var k;if(!g.particle){k=this.makeNodeModel(g);var i=this.makeNodeView(g,k);this.view.addNode(k,i);if(g.fixed){k.fixed=true}}else{k=g.particle}var c=Math.random()*2-1;var b=Math.random()*2-1;k.positionX=c;k.positionY=b;for(pIdx in g.parent){var a=g.parent[pIdx];if(isNaN(pIdx)){continue}if(!a.particle){this.newDataGraphEdge(g,a);continue;g.particle=k;this.addParticle(a)}k.positionX=a.particle.positionX+c;k.positionY=a.particle.positionY+b;var e=(g.type in this.forces.spring&&a.type in this.forces.spring[g.type])?this.forces.spring[g.type][a.type](g,a,true):this.forces.spring._default(g,a,true);this.model.makeSpring(k,a.particle,e.springConstant,e.dampingConstant,e.restLength);var n=this.viewEdgeBuilder(a,g);this.view.addEdge(k,a.particle,n)}for(var h=0,f=this.model.particles.length;h<f;h++){if(this.model.particles[h]!=k){var d=this.forces.magnet()["magnetConstant"];var m=this.forces.magnet()["minimumDistance"];this.model.makeMagnet(k,this.model.particles[h],d,m)}}g.particle=k;g.viewNode=i;return g};ForceDirectedLayout.prototype.addSimilarity=function(d,c){var a=(d.type in this.forces.spring&&c.type in this.forces.spring[d.type])?this.forces.spring[d.type][c.parent.type](d,c,false):this.forces.spring._default(d,c,false);this.model.makeSpring(d.particle,c.particle,a.springConstant,a.dampingConstant,a.restLength);var b=this.viewEdgeBuilder(d,c);this.view.addEdge(d.particle,c.particle,b)};ForceDirectedLayout.prototype.makeNodeView=function(b,c){var a=(b.type in this.config)?this.config[b.type]:this.config._default;return a.view(b,c)};ForceDirectedLayout.prototype.makeNodeModel=function(b){var a=(b.type in this.config)?this.config[b.type]:this.config._default;for(var d in a.model(b)){b[d]=a.model(b)[d]}var c=this.model.makeParticle(b.mass,0,0);return c};ForceDirectedLayout.prototype.defaultNodeView=function(a,b){var c;if(this.svg){c=document.createElementNS("http://www.w3.org/2000/svg","circle");c.setAttribute("stroke","#444444");c.setAttribute("stroke-width",".25px");c.setAttribute("fill","#aaaaaa");c.setAttribute("r",6+"px");c.onmousedown=new EventHandler(this,this.handleMouseDownEvent,b.id)}else{c=document.createElement("div");c.style.position="absolute";c.style.width="12px";c.style.height="12px";c.style.backgroundImage="url(http://kylescholz.com/cgi-bin/bubble.pl?title=&r=12&pt=8&b=444444&c=aaaaaa)";c.innerHTML='<img width="1" height="1">';c.onmousedown=new EventHandler(this,this.handleMouseDownEvent,b.id)}return c};ForceDirectedLayout.prototype.makeEdgeView=function(c,b){var a;if(this.svg){a={stroke:"#888888","stroke-width":"2px","stroke-dasharray":"2,4"}}else{a={pixelColor:"#888888",pixelWidth:"2px",pixelHeight:"2px",pixels:5}}return a};ForceDirectedLayout.prototype.viewEdgeBuilder=ForceDirectedLayout.prototype.makeEdgeView;