var ParticleModel=function(a){this.init(a)};ParticleModel.prototype={init:function(a){this.ENTROPY_THROTTLE=true;this.view=a;this.particles=new Array();this.nextParticleId=0;this.springs=new Array();this.activeSprings=new Array();this.springLast=0;this.magnets=new Array();this.activeMagnets=new Array();this.magLast=0;this.integrator=new RungeKuttaIntegrator(this,a);this.timer=new Timer(1);this.timer.subscribe(this);this.setSize(this.view.frameWidth,this.view.frameHeight,this.view.skewX,this.view.skewY)},tick:function(){this.integrator.step(1);return this.draw()},setSize:function(a,b){this.boundsLeft=(-a/this.view.skewX)/2+20;this.boundsRight=(a/this.view.skewX)/2-20;this.boundsTop=(-b/this.view.skewY)/2+10;this.boundsBottom=(b/this.view.skewY)/2-15},draw:function(a){var h=this.view;var m=this.particles;var g=0;var k=this.view.skewX;var j=this.view.skewY;for(var c=0,b=m.length;c<b;c++){var d=m[c];if(c==0){d.positionY=this.boundsTop}if(this.boundsLeft){if(d.positionX<this.boundsLeft+(d.width/2)/k){d.positionX=this.boundsLeft+(d.width/2)/k}else{if(d.positionX>(this.boundsRight-(d.width/2)/k)){d.positionX=this.boundsRight-(d.width/2)/k}}if(d.positionY<this.boundsTop+(d.height/2/j)){d.positionY=this.boundsTop+(d.height/2/j)}else{if(d.positionY>(this.boundsBottom-(d.height/2/j))){d.positionY=this.boundsBottom-(d.height/2/j)}}}var f=Math.round(d.positionX*2)/2;var e=Math.round(d.positionY*2)/2;if(f!=d.lastDrawPositionX||e!=d.lastDrawPositionY||a){h.drawNode(d);g++}d.lastDrawPositionX=f;d.lastDrawPositionY=e}return g},makeParticle:function(b,a,d){var c=new Particle(b,a,d);c.id=this.nextParticleId++;this.particles.push(c);this["integrator"].allocateParticle(c.id);if(this.timer.interupt){this.timer.start()}return c},makeSpring:function(e,c,g,h,f){var d=new Spring(e,c,g,h,f);this.springs.push(d);this.activeSprings.push(d);return(d)},makeMagnet:function(d,c,f,e){var h=new Magnet(d,c,f,e);this.magnets.push(h);this.activeMagnets.push(h);if(this.activeMagnets.length>50){this.activeMagnets.shift()}return h},applyForces:function(){var d=this.activeSprings;var g=this.springs;var b=this.springLast;var h=parseInt(g.length/10);for(var e=0,c=d.length;e<c;e++){d[e].apply();d[e].age++}var k=this.activeSprings.length;if(k>0&&this.activeSprings[0].age>20){this.activeSprings.shift()}for(var e=b,n=b+h,c=g.length;e<n&&e<c;e++){g[e].apply()}this["springLast"]+=h;if(this["springLast"]>=g.length){this["springLast"]=0}var f=this.activeMagnets;var m=this.magnets;var a=this["magLast"];h=parseInt(m.length/10);for(var e=0,c=f.length;e<c;e++){f[e].apply();f[e].age++}var j=this.activeMagnets.length;if(j>0&&this.activeMagnets[0].age>50){this.activeMagnets.shift()}for(var e=a,n=a+h,c=m.length;e<n&&e<c;e++){m[e].apply()}this["magLast"]+=h;if(this["magLast"]>=m.length){this["magLast"]=0}},reset:function(){var d=this.springs;for(var c=0,a=d.length;c<a;c++){d[c].forceX=0;d[c].forceY=0}var b=this.magnets;for(var c=0,a=b.length;c<a;c++){b[c].forceX=0;b[c].forceY=0}var e=this.particles;for(var c=0,a=e.length;c<a;c++){e[c].forceX=0;e[c].forceY=0}var e=this.particles;for(var c=0,a=e.length;c<a;c++){this.integrator.allocateParticle(c)}if(this.timer.interupt){this.timer.start()}},update:function(){var b=this.tick();var a=1;if(this.ENTROPY_THROTTLE&&this.particles.length>2){var c=(b/(this.particles.length));if(c<0.01){this.stop()}else{if(c<0.05){return(1000)}else{if(c<0.1){return(200)}}}return(1)}return a},start:function(){this.timer.start()},stop:function(){this.timer.stop()},clear:function(){this.particles=new Array();this.nextParticleId=0;this.springs=new Array();this.activeSprings=new Array();this.springLast=0;this.magnets=new Array();this.activeMagnets=new Array();this.magLast=0;this.view.clear();this.integrator.initialize(this,this.view)}};